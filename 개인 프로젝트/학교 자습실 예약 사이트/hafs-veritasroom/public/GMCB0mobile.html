<!DOCTYPE html>
<html>
    <head>
        <title>HAFS자습실 : Veritas Room</title>
        <link rel="shortcut icon" type="image⁄x-icon" href="Images/cloud.png">
        <meta charset = "utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1">    
        <link rel="stylesheet" href="mobile.css">
        <!-- 초기화 -->
        <style>
            *{margin:0; padding:0;}
            li{list-style: none;}
            a{text-decoration: none;}
            body 
            {
                max-width: 100%;
                overflow-x: hidden;
                font-family:'Malgun Gothic';
                height: 100vh;
            }
            html{
                max-width: 100%;
                overflow-x: hidden;
                height: 100vh;
            }
        </style>
        <!-- body -->
        <style>
            @font-face{
                font-family: 'Oswald';
                src:url('fonts/Oswald-Light.ttf') format('truetype');
            }
            .background{
                width:100%;
                height: 100vh;
                background-color:rgb(51,51,51);
            }
            .place{
                width: 100%;
                height: 10%;
                background-color: rgb(240,240,240);
                font-family: 'Malgun Gothic';
                font-size:18px;
                font-weight: 53 0;
                display:table;
            }
            .table{
                display:table-cell;
                vertical-align: middle;
                padding-left:15px;
            }
            .reservation{
                width: 100%;
                height: 75%;
            }
            .input{
                width: 100%;
                height: 15%;
                background-color: white;
            }
            .door{
                height:100%;
                width:10%;
                margin-left: 4%;
                float:left;
            }
            .mdoor{
                border: 1.5px solid rgb(102,102,102);
                float: center;
                width:100%;
                height:90%;
                writing-mode: vertical-rl;
                text-orientation: mixed;
                text-align:center;
                display:table;
            }
            .mdoor div{
                display:table-cell;
                vertical-align: middle;
                font-size:22px;
                font-family: Oswald;
                font-weight: 700;
                color:rgb(102,102,102);
            }
            .stxt{
                float: center;
                width:100%;
                height:100%;
                text-align:center;
                display:table;
                background-color:rgb(102,102,102);
            }
            .stxt div{
                display:table-cell;
                vertical-align: middle;
                font-size:18px;
                font-family: Oswald;
                font-weight: 500;
                color:white;
            }
            .sdoor{
                float: center;
                widows: 100%;
                height:5%;
            }
            .A{
                width: 75%;
                height: 8.5%;
                float:left;
                margin-top: 15px;
            }
            .rbox{
                height:40px;
                width:40px;
                margin:0;
                float:right;
                margin-right:5px;
                border:0;
                outline:0;
            }
            .button{
                background-color: rgb(197,197,197);
                float:right;
                width:30%;
                height:100%;
                border:0;
                outline:0;
                color: white;
                font-family: oswald;
                font-size: 16px;
            }
            .inputtxt{
                width: 70%;
                height:100%;
                display:table;
            }
            .inputtxt div{
                display:table-cell;
                vertical-align: middle;
                font-size:18px;
                width:100%;
                height:23.2px;
                text-align: center;
            }
        </style>
    </head>

    <body>
        <div class="background">
            <div class="place">
                <div class="table">
                    남자 기숙사 지하 1층 자습실
                </div>
            </div>
            <div class="reservation">
                <div class="door">
                    <div class="sdoor"></div>
                    <div class="mdoor"><div>DOOR</div></div>
                    <div class="sdoor"></div>
                </div>
                <div class ="A">
                    <button class="rbox" value="A1">
                        <div class="stxt" id="A1"><div>A1</div></div>
                    </button>
                    <button class="rbox" value="A2">
                        <div class="stxt" id="A2"><div>A2</div></div>
                    </button>
                    <button class="rbox" value="A3">
                        <div class="stxt" id="A3"><div>A3</div></div>
                    </button>
                    <button class="rbox" value="A4">
                        <div class="stxt" id="A4"><div>A4</div></div>
                    </button>
                    <button class="rbox" value="A5">
                        <div class="stxt" id="A5"><div>A5</div></div>
                    </button>
                </div>
                <div class ="A">
                    <button class="rbox" value="B1">
                        <div class="stxt" id="B1"><div>B1</div></div>
                    </button>
                    <button class="rbox" value="B2">
                        <div class="stxt" id="B2"><div>B2</div></div>
                    </button>
                    <button class="rbox" value="B3">
                        <div class="stxt" id="B3"><div>B3</div></div>
                    </button>
                    <button class="rbox" value="B4">
                        <div class="stxt" id="B4"><div>B4</div></div>
                    </button>
                    <button class="rbox" value="B5">
                        <div class="stxt" id="B5"><div>B5</div></div>
                    </button>
                </div>
                <div class ="A">
                    <button class="rbox" value="C1">
                        <div class="stxt" id="C1"><div>C1</div></div>
                    </button>
                    <button class="rbox" value="C2">
                        <div class="stxt" id="C2"><div>C2</div></div>
                    </button>
                    <button class="rbox" value="C3">
                        <div class="stxt" id="C3"><div>C3</div></div>
                    </button>
                    <button class="rbox" value="C4">
                        <div class="stxt" id="C4"><div>C4</div></div>
                    </button>
                    <button class="rbox" value="C5">
                        <div class="stxt" id="C5"><div>C5</div></div>
                    </button>
                </div>
                <div class ="A">
                    <button class="rbox" value="D1">
                        <div class="stxt" id="D1"><div>D1</div></div>
                    </button>
                    <button class="rbox" value="D2">
                        <div class="stxt" id="D2"><div>D2</div></div>
                    </button>
                    <button class="rbox" value="D3">
                        <div class="stxt" id="D3"><div>D3</div></div>
                    </button>
                    <button class="rbox" value="D4">
                        <div class="stxt" id="D4"><div>D4</div></div>
                    </button>
                    <button class="rbox" value="D5">
                        <div class="stxt" id="D5"><div>D5</div></div>
                    </button>
                </div>
                <div class ="A">
                    <button class="rbox" value="E1">
                        <div class="stxt" id="E1"><div>E1</div></div>
                    </button>
                    <button class="rbox" value="E2">
                        <div class="stxt" id="E2"><div>E2</div></div>
                    </button>
                    <button class="rbox" value="E3">
                        <div class="stxt" id="E3"><div>E3</div></div>
                    </button>
                    <button class="rbox" value="E4">
                        <div class="stxt" id="E4"><div>E4</div></div>
                    </button>
                    <button class="rbox" value="E5">
                        <div class="stxt" id="E5"><div>E5</div></div>
                    </button>
                </div>
                <div class ="A">
                    <button class="rbox" value="F1">
                        <div class="stxt" id="F1"><div>F1</div></div>
                    </button>
                    <button class="rbox" value="F2">
                        <div class="stxt" id="F2"><div>F2</div></div>
                    </button>
                    <button class="rbox" value="F3">
                        <div class="stxt" id="F3"><div>F3</div></div>
                    </button>
                    <button class="rbox" value="F4">
                        <div class="stxt" id="F4"><div>F4</div></div>
                    </button>
                    <button class="rbox" value="F5">
                        <div class="stxt" id="F5"><div>F5</div></div>
                    </button>
                </div>
                <div class ="A">
                    <button class="rbox" value="G1">
                        <div class="stxt" id="G1"><div>G1</div></div>
                    </button>
                    <button class="rbox" value="G2">
                        <div class="stxt" id="G2"><div>G2</div></div>
                    </button>
                    <button class="rbox" value="G3">
                        <div class="stxt" id="G3"><div>G3</div></div>
                    </button>
                    <button class="rbox" value="G4">
                        <div class="stxt" id="G4"><div>G4</div></div>
                    </button>
                    <button class="rbox" value="G5">
                        <div class="stxt" id="G5"><div>G5</div></div>
                    </button>
                </div>
                <div class ="A">
                    <button class="rbox" value="H1">
                        <div class="stxt" id="H1"><div>H1</div></div>
                    </button>
                    <button class="rbox" value="H2">
                        <div class="stxt" id="H2"><div>H2</div></div>
                    </button>
                    <button class="rbox" value="H3">
                        <div class="stxt" id="H3"><div>H3</div></div>
                    </button>
                    <button class="rbox" value="H4">
                        <div class="stxt" id="H4"><div>H4</div></div>
                    </button>
                    <button class="rbox" value="H5">
                        <div class="stxt" id="H5"><div>H5</div></div>
                    </button>
                </div>
            </div>
            <div class="input">                
                <input class="button" type="button" onclick="submit()" value="예약" id="button">
                <span id="inputtxt"></span>
            </div>
        </div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.10.1/firebase.js"></script>
        <script>
            var firebaseEmailAuth;
            var firebaseDatabase;
            var config = {
                apiKey: "AIzaSyDaIdnpBCFNFuBJb5TmypMQxkfyIkA96GY",
                authDomain: "hafs-sc.firebaseapp.com",
                databaseURL: "https://hafs-sc.firebaseio.com",
                projectId: "hafs-sc",
                storageBucket: "gs://hafs-sc.appspot.com/",
                messagingSenderId: "493941439878"
            };
            firebase.initializeApp(config);
       
            firebaseEmailAuth = firebase.auth();
            firebaseDatabase = firebase.database();

            var input;
            var getinputId= document.getElementById("inputtxt");
            var getbuttonId = document.getElementById("button");
            $("button").click(function() {
                input = $(this).val();
                firebase.auth().onAuthStateChanged(function(user) {
                    var user = firebase.auth().currentUser;
                    if (user== null) {
                        alert("로그인 후 이용할 수 있습니다.");
                    }
                    else{
                        getinputId.innerHTML = '<div class="inputtxt" id="inputtxt"><div>선택한 좌석 : '+input+'</div></div>';
                        firebase.auth().onAuthStateChanged(function(user) {
                            var user = firebase.auth().currentUser;
                            firebaseDatabase.ref("users/"+user.uid).once('value').then(function(snapshot){
                                var right = snapshot.val().veritasroom
                                right = right.substring(5,7);
                                if(right==input){
                                    getbuttonId.style.backgroundColor="rgb(255,110,111)"
                                    getbuttonId.value="예약 취소"

                                }
                                else{
                                    getbuttonId.style.backgroundColor="rgb(62,133,228)";
                                }
                            });
                        });
                    }
                });
                
            });
            function submit(){
                if(input == undefined){
                    alert("좌석 지정 후 예약 버튼을 눌러 주세요.");
                }
                else{
                    firebase.auth().onAuthStateChanged(function(user) {
                        var user = firebase.auth().currentUser;
                        firebaseDatabase.ref("users/"+user.uid).once('value').then(function(snapshot){
                            var right = snapshot.val().veritasroom
                            if(right!='none'){
                                right = right.substring(5,7);
                                if(input==right){
                                    firebaseDatabase.ref("veritasroom/GMCB0/"+input[0]).once('value').then(function(snapshot){
                                        var sitPlace =String(Number(input[1])-1);
                                        var sitList = snapshot.val();
                                        var sit = snapshot.val()[sitPlace];
                                        sitList[sitPlace] = 0;
                                        firebase.database().ref('users/'+user.uid).update({veritasroom : "none",});
                                        firebase.database().ref("veritasroom/GMCB0/"+input[0]).update(sitList);
                                    });
                                    firebaseDatabase.ref("veritasroom/GMCB0/").once('value').then(function(snapshot){
                                        var total = snapshot.val().total;
                                        total +=1;
                                        firebase.database().ref("veritasroom/GMCB0").update({total:total});
                                    });
                                    
                                    alert("예약이 취소되었습니다.");
                                    location.reload();
                                }
                                else{
                                    alert("회원님은 이미 자리를 하나 이상 보유하고 있습니다.");
                                }
                            }
                            else{
                                firebaseDatabase.ref("veritasroom/GMCB0/"+input[0]).once('value').then(function(snapshot){
                                    var sitPlace =String(Number(input[1])-1);
                                    var sitList = snapshot.val();
                                    var sit = snapshot.val()[sitPlace];
                                    sitList[sitPlace] = 1;
                                    if (sit != 0){
                                        alert("다른 회원님이 사용 중인 자리입니다.");
                                    }
                                    else{
                                        firebase.database().ref('users/'+user.uid).update({veritasroom : 'GMCB0'+input,});
                                        firebase.database().ref("veritasroom/GMCB0/"+input[0]).update(sitList);
                                        firebaseDatabase.ref("veritasroom/GMCB0/").once('value').then(function(snapshot){
                                            var total = snapshot.val().total;
                                            total -=1;
                                            firebase.database().ref("veritasroom/GMCB0").update({total:total});
                                        });
                                        alert(input+" 자리가 예약되었습니다. 열공하세요 :)");
                                        location.reload();
                                    }
                                });
                            }
                        });
                    });
                }
            }


            firebaseDatabase.ref("veritasroom/GMCB0/").once('value').then(function(snapshot){
                var line = snapshot.val()
                for (var i in line){
                    for (k in line[i]){
                        var getsitId= document.getElementById(i+String(Number(k)+1));
                        if (line[i][k]!=0)
                        {
                            getsitId.style.border="1px solid red";
                        }
                        else{
                            getsitId.style.border="1px solid green";
                        }
                    }
                }
            });

            window.onload = function(){
                timer = window.setInterval(
                    function(){
                        var currentHour = new Date().getHours();
                        var currentMinute = new Date().getMinutes();
                        if (currentHour==15 && currentMinute == 58) {
                            firebase.database().ref('veritasroom/GMCB0').update({total : 40,});
                            firebase.database().ref('veritasroom/GMCB0/A').update({
                                0 : 0,
                                1 : 0,
                                2 : 0,
                                3 : 0,
                                4 : 0,
                            });
                            firebase.database().ref('veritasroom/GMCB0/B').update({
                                0 : 0,
                                1 : 0,
                                2 : 0,
                                3 : 0,
                                4 : 0,
                            });
                            firebase.database().ref('veritasroom/GMCB0/C').update({
                                0 : 0,
                                1 : 0,
                                2 : 0,
                                3 : 0,
                                4 : 0,
                            });
                            firebase.database().ref('veritasroom/GMCB0/D').update({
                                0 : 0,
                                1 : 0,
                                2 : 0,
                                3 : 0,
                                4 : 0,
                            });
                            firebase.database().ref('veritasroom/GMCB0/E').update({
                                0 : 0,
                                1 : 0,
                                2 : 0,
                                3 : 0,
                                4 : 0,
                            });
                            firebase.database().ref('veritasroom/GMCB0/F').update({
                                0 : 0,
                                1 : 0,
                                2 : 0,
                                3 : 0,
                                4 : 0,
                            });
                            firebase.database().ref('veritasroom/GMCB0/A').update({
                                0 : 0,
                                1 : 0,
                                2 : 0,
                                3 : 0,
                                4 : 0,
                            });
                            firebase.database().ref('veritasroom/GMCB0/G').update({
                                0 : 0,
                                1 : 0,
                                2 : 0,
                                3 : 0,
                                4 : 0,
                            });
                            firebase.database().ref('veritasroom/GMCB0/H').update({
                                0 : 0,
                                1 : 0,
                                2 : 0,
                                3 : 0,
                                4 : 0,
                            });
                        }
                    },50000);
            }
        </script>
    </body>
</html>